<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV WordCloud Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.2/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-bg: #f5f5f5;
            --panel-bg: #ffffff;
            --border: #e0e0e0;
            --text: #333333;
            --accent: #4a86e8;
            --hover: #3a76d8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: var(--primary-bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            gap: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
        }

        .app-description {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }

        .grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background-color: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group h3 {
            font-size: 16px;
            margin-bottom: 5px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input, select, button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
        }

        input[type="file"] {
            padding: 8px 0;
        }

        input[type="color"] {
            height: 40px;
            padding: 2px;
        }

        .color-pickers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            background-color: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px 15px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: var(--hover);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .preview-panel {
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }

        #wordcloud-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: white;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        svg {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }

        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            font-size: 18px;
            font-weight: bold;
        }

        .preview-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            gap: 10px;
        }

        .checkbox-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .checkbox-group input {
            width: auto;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .slider-values {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }

        .download-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .info-text {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        #error-message {
            color: #d32f2f;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CSV WordCloud Generator</h1>
        <p class="app-description">Upload a CSV file, customise your word cloud, and export as a high-resolution image</p>

        <div class="grid">
            <div class="panel control-panel">
                <div class="control-group">
                    <h3>Data Input</h3>
                    <label for="csv-file">Upload CSV file:</label>
                    <input type="file" id="csv-file" accept=".csv" />
                    <p class="info-text">Your CSV can have either a single text column or separate text and weight columns</p>
                    
                    <label for="column-select">Text column:</label>
                    <select id="column-select" disabled>
                        <option value="">Select column after uploading CSV</option>
                    </select>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="use-weight-column" />
                        <label for="use-weight-column">Use weight column</label>
                    </div>
                    
                    <label for="weight-column-select" id="weight-column-label" style="display: none;">Weight column:</label>
                    <select id="weight-column-select" disabled style="display: none;">
                        <option value="">Select weight column</option>
                    </select>
                    <p class="info-text" id="weight-column-info" style="display: none;">Select the column containing numerical weights/frequencies</p>
                    <div id="error-message"></div>
                </div>

                <div class="control-group">
                    <h3>Cloud Shape</h3>
                    <label for="shape-file">Upload shape image (optional):</label>
                    <input type="file" id="shape-file" accept="image/*" />
                    <p class="info-text">For best results, use a simple black silhouette on white background</p>
                </div>

                <div class="control-group">
                    <h3>Colour Settings</h3>
                    <div class="color-pickers">
                        <div>
                            <label for="start-color">Start colour:</label>
                            <input type="color" id="start-color" value="#3b82f6" />
                        </div>
                        <div>
                            <label for="end-color">End colour:</label>
                            <input type="color" id="end-color" value="#8b5cf6" />
                        </div>
                    </div>
                    <label for="background-color">Background colour:</label>
                    <input type="color" id="background-color" value="#ffffff" />
                </div>

                <div class="control-group">
                    <h3>Text Settings</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="keep-phrases" />
                        <label for="keep-phrases">Keep phrases together</label>
                    </div>
                    
                    <div class="slider-group">
                        <label for="min-word-length">Minimum word length: <span id="min-word-length-value">3</span></label>
                        <input type="range" id="min-word-length" min="1" max="10" value="3" />
                        <div class="slider-values">
                            <span>1</span>
                            <span>10</span>
                        </div>
                    </div>
                    
                    <div class="slider-group">
                        <label for="max-words">Max words: <span id="max-words-value">100</span></label>
                        <input type="range" id="max-words" min="10" max="300" value="100" />
                        <div class="slider-values">
                            <span>10</span>
                            <span>300</span>
                        </div>
                    </div>
                    
                    <label for="stopwords">Stopwords (comma separated):</label>
                    <input type="text" id="stopwords" placeholder="the,and,of,to,a,in,for,is,on,that,by,this,with" value="the,and,of,to,a,in,for,is,on,that,by,this,with" />
                </div>

                <div class="control-group">
                    <h3>Export</h3>
                    <div class="slider-group">
                        <label for="export-scale">Export scale: <span id="export-scale-value">2</span>x</label>
                        <input type="range" id="export-scale" min="1" max="4" step="0.5" value="2" />
                        <div class="slider-values">
                            <span>1x</span>
                            <span>4x</span>
                        </div>
                    </div>
                    <div class="download-options">
                        <button id="download-png">Download PNG</button>
                        <button id="download-svg">Download SVG</button>
                    </div>
                </div>

                <button id="generate-btn">Generate WordCloud</button>
            </div>

            <div class="panel preview-panel">
                <div id="wordcloud-container"></div>
                <div class="preview-controls">
                    <div class="slider-group">
                        <label for="rotation-range">Rotation range: <span id="rotation-range-value">±30°</span></label>
                        <input type="range" id="rotation-range" min="0" max="90" value="30" />
                        <div class="slider-values">
                            <span>0°</span>
                            <span>±90°</span>
                        </div>
                    </div>
                    <div class="slider-group">
                        <label for="scale-factor">Size scaling: <span id="scale-factor-value">1</span>x</label>
                        <input type="range" id="scale-factor" min="0.5" max="2" step="0.1" value="1" />
                        <div class="slider-values">
                            <span>0.5x</span>
                            <span>2x</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            CSV WordCloud Generator | A client-side tool that can be deployed via GitHub Pages
        </footer>
    </div>

    <script>
        // Global variables
        let csvData = null;
        let selectedColumn = null;
        let wordcloudLayout = null;
        let shapeImage = null;
        let wordFrequencies = [];
        let isGenerating = false;
        
        // DOM elements
        const csvFileInput = document.getElementById('csv-file');
        const columnSelect = document.getElementById('column-select');
        const useWeightColumnCheckbox = document.getElementById('use-weight-column');
        const weightColumnSelect = document.getElementById('weight-column-select');
        const weightColumnLabel = document.getElementById('weight-column-label');
        const weightColumnInfo = document.getElementById('weight-column-info');
        const shapeFileInput = document.getElementById('shape-file');
        const startColorInput = document.getElementById('start-color');
        const endColorInput = document.getElementById('end-color');
        const backgroundColorInput = document.getElementById('background-color');
        const keepPhrasesCheckbox = document.getElementById('keep-phrases');
        const minWordLengthInput = document.getElementById('min-word-length');
        const minWordLengthValue = document.getElementById('min-word-length-value');
        const maxWordsInput = document.getElementById('max-words');
        const maxWordsValue = document.getElementById('max-words-value');
        const stopwordsInput = document.getElementById('stopwords');
        const rotationRangeInput = document.getElementById('rotation-range');
        const rotationRangeValue = document.getElementById('rotation-range-value');
        const scaleFactorInput = document.getElementById('scale-factor');
        const scaleFactorValue = document.getElementById('scale-factor-value');
        const exportScaleInput = document.getElementById('export-scale');
        const exportScaleValue = document.getElementById('export-scale-value');
        const generateBtn = document.getElementById('generate-btn');
        const downloadPngBtn = document.getElementById('download-png');
        const downloadSvgBtn = document.getElementById('download-svg');
        const wordcloudContainer = document.getElementById('wordcloud-container');
        const errorMessage = document.getElementById('error-message');

        // Initialize the UI
        function init() {
            // Set up event listeners
            csvFileInput.addEventListener('change', handleCSVUpload);
            columnSelect.addEventListener('change', updateSelectedColumn);
            useWeightColumnCheckbox.addEventListener('change', toggleWeightColumnOptions);
            weightColumnSelect.addEventListener('change', updateSelectedColumn);
            shapeFileInput.addEventListener('change', handleShapeUpload);
            generateBtn.addEventListener('click', generateWordCloud);
            downloadPngBtn.addEventListener('click', downloadAsPNG);
            downloadSvgBtn.addEventListener('click', downloadAsSVG);
            
            // Set up slider value updates
            minWordLengthInput.addEventListener('input', () => {
                minWordLengthValue.textContent = minWordLengthInput.value;
            });
            
            maxWordsInput.addEventListener('input', () => {
                maxWordsValue.textContent = maxWordsInput.value;
            });
            
            rotationRangeInput.addEventListener('input', () => {
                rotationRangeValue.textContent = `±${rotationRangeInput.value}°`;
            });
            
            scaleFactorInput.addEventListener('input', () => {
                scaleFactorValue.textContent = scaleFactorInput.value;
            });
            
            exportScaleInput.addEventListener('input', () => {
                exportScaleValue.textContent = exportScaleInput.value;
            });
            
            // Disable download buttons initially
            downloadPngBtn.disabled = true;
            downloadSvgBtn.disabled = true;
        }
        
        // Function to toggle weight column options
        function toggleWeightColumnOptions() {
            const useWeightColumn = useWeightColumnCheckbox.checked;
            
            weightColumnLabel.style.display = useWeightColumn ? 'block' : 'none';
            weightColumnSelect.style.display = useWeightColumn ? 'block' : 'none';
            weightColumnInfo.style.display = useWeightColumn ? 'block' : 'none';
            
            // Update button state based on selections
            updateSelectedColumn();
        }

        // Function to handle CSV file upload
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Show loading message
            showLoading('Parsing CSV...');
            
            // Parse the CSV file
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    csvData = results.data;
                    
                    // Clear any previous error
                    hideError();
                    
                    // Check if CSV has data
                    if (!csvData || csvData.length === 0) {
                        showError('CSV file is empty or invalid.');
                        hideLoading();
                        return;
                    }
                    
                    // Populate column dropdown
                    populateColumnSelect(results.meta.fields);
                    hideLoading();
                },
                error: function(error) {
                    console.error('Error parsing CSV:', error);
                    showError('Error parsing CSV. Please check file format.');
                    hideLoading();
                }
            });
        }

        // Function to populate column select dropdowns
        function populateColumnSelect(columns) {
            // For text column select
            columnSelect.innerHTML = '';
            columnSelect.disabled = false;
            
            const defaultTextOption = document.createElement('option');
            defaultTextOption.value = '';
            defaultTextOption.textContent = 'Select text column';
            columnSelect.appendChild(defaultTextOption);
            
            // For weight column select
            weightColumnSelect.innerHTML = '';
            weightColumnSelect.disabled = false;
            
            const defaultWeightOption = document.createElement('option');
            defaultWeightOption.value = '';
            defaultWeightOption.textContent = 'Select weight column';
            weightColumnSelect.appendChild(defaultWeightOption);
            
            // Add column options to both dropdowns
            columns.forEach(column => {
                // For text column
                const textOption = document.createElement('option');
                textOption.value = column;
                textOption.textContent = column;
                columnSelect.appendChild(textOption);
                
                // For weight column
                const weightOption = document.createElement('option');
                weightOption.value = column;
                weightOption.textContent = column;
                weightColumnSelect.appendChild(weightOption);
            });
            
            // Restore previous selections if they exist in the new data
            if (selectedColumn && columns.includes(selectedColumn)) {
                columnSelect.value = selectedColumn;
            }
            
            updateSelectedColumn();
        }

        // Function to update selected columns and button state
        function updateSelectedColumn() {
            selectedColumn = columnSelect.value;
            const useWeightColumn = useWeightColumnCheckbox.checked;
            const selectedWeightColumn = weightColumnSelect.value;
            
            // Enable generate button if text column is selected AND (weight column is not used OR weight column is selected)
            generateBtn.disabled = !selectedColumn || (useWeightColumn && !selectedWeightColumn);
        }

        // Function to handle shape image upload
        function handleShapeUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                shapeImage = null;
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    shapeImage = img;
                    // If a word cloud has already been generated, regenerate it with the new shape
                    if (wordFrequencies.length > 0) {
                        generateWordCloud();
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Function to process text and count word frequencies
        function processText(text, keepPhrases, minWordLength, stopwords) {
            // Convert stopwords to an array and trim each word
            const stopwordList = stopwords
                .split(',')
                .map(word => word.trim().toLowerCase())
                .filter(word => word);
                
            // If keeping phrases intact, split by punctuation but keep words together
            // Otherwise, split by any non-alphanumeric character
            const regex = keepPhrases 
                ? /[.!?;]+/
                : /[^a-zA-Z0-9']+/;
                
            const words = text.split(regex)
                .flatMap(phrase => {
                    if (keepPhrases) {
                        return phrase.trim();
                    } else {
                        return phrase.split(/\s+/);
                    }
                })
                .map(word => word.trim().toLowerCase())
                .filter(word => {
                    // Keep words that are longer than minimum length and not in stopwords
                    return word.length >= minWordLength && 
                           !stopwordList.includes(word) &&
                           word.length > 0;
                });
                
            // Count frequency of each word
            const wordCount = {};
            words.forEach(word => {
                wordCount[word] = (wordCount[word] || 0) + 1;
            });
            
            // Convert to array of {text, value} objects and sort by frequency
            return Object.entries(wordCount)
                .map(([text, value]) => ({ text, value }))
                .sort((a, b) => b.value - a.value);
        }
        
        // Function to process precomputed data from text and weight columns
        function processPrecomputedData(textColumn, weightColumn) {
            const stopwords = stopwordsInput.value.split(',')
                .map(word => word.trim().toLowerCase())
                .filter(word => word);
                
            const minWordLength = parseInt(minWordLengthInput.value);
            
            // Extract word-weight pairs from CSV
            const wordWeights = {};
            
            csvData.forEach(row => {
                const text = row[textColumn];
                const weight = parseFloat(row[weightColumn]);
                
                // Skip rows with invalid data
                if (!text || typeof text !== 'string' || isNaN(weight)) {
                    return;
                }
                
                // Process the text based on settings
                const processedText = text.trim().toLowerCase();
                
                // Skip stopwords and short words
                if (stopwords.includes(processedText) || processedText.length < minWordLength) {
                    return;
                }
                
                // Sum weights for duplicate words
                wordWeights[processedText] = (wordWeights[processedText] || 0) + weight;
            });
            
            // Convert to array of {text, value} objects and sort by frequency
            return Object.entries(wordWeights)
                .map(([text, value]) => ({ text, value }))
                .sort((a, b) => b.value - a.value);
        }

        // Function to generate color scale
        function generateColorScale(startColor, endColor, steps) {
            return d3.scaleLinear()
                .domain([0, steps - 1])
                .range([startColor, endColor])
                .interpolate(d3.interpolateHcl);
        }

        // Function to create a canvas mask from image
        function createMaskCanvas(img, width, height) {
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // Draw the image
            ctx.drawImage(img, 0, 0, width, height);
            
            // Get image data
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            // Create mask based on brightness (assuming black shape on white background)
            for (let i = 0; i < data.length; i += 4) {
                // Calculate brightness (simple average)
                const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                
                // Set alpha based on brightness (darker = more opaque)
                data[i + 3] = brightness < 128 ? 255 : 0;
            }
            
            // Put the modified image data back
            ctx.putImageData(imageData, 0, 0);
            
            return canvas;
        }

        // Function to generate word cloud
        function generateWordCloud() {
            if (!csvData || !selectedColumn) {
                showError('Please upload a CSV file and select a text column.');
                return;
            }
            
            const useWeightColumn = useWeightColumnCheckbox.checked;
            const selectedWeightColumn = weightColumnSelect.value;
            
            if (useWeightColumn && !selectedWeightColumn) {
                showError('Please select a weight column or uncheck "Use weight column".');
                return;
            }
            
            if (isGenerating) return;
            isGenerating = true;
            
            showLoading('Generating word cloud...');
            
            // Get settings
            const keepPhrases = keepPhrasesCheckbox.checked;
            const minWordLength = parseInt(minWordLengthInput.value);
            const maxWords = parseInt(maxWordsInput.value);
            const stopwords = stopwordsInput.value;
            const rotationRange = parseInt(rotationRangeInput.value);
            const scaleFactor = parseFloat(scaleFactorInput.value);
            const startColor = startColorInput.value;
            const endColor = endColorInput.value;
            const backgroundColor = backgroundColorInput.value;
            
            // Clear previous word cloud
            wordcloudContainer.innerHTML = '';
            
            // Process word frequencies based on input mode
            if (useWeightColumn) {
                // Using pre-defined weights from CSV
                wordFrequencies = processPrecomputedData(selectedColumn, selectedWeightColumn);
            } else {
                // Combine all text from the selected column
                let combinedText = '';
                csvData.forEach(row => {
                    const cellValue = row[selectedColumn];
                    if (cellValue && typeof cellValue === 'string') {
                        combinedText += ' ' + cellValue;
                    }
                });
                
                if (!combinedText.trim()) {
                    showError('Selected column does not contain text data.');
                    isGenerating = false;
                    hideLoading();
                    return;
                }
                
                // Process text to get word frequencies
                wordFrequencies = processText(combinedText, keepPhrases, minWordLength, stopwords);
            }
            
            // Limit to max words
            wordFrequencies = wordFrequencies.slice(0, maxWords);
            
            if (wordFrequencies.length === 0) {
                showError('No words found after applying filters.');
                isGenerating = false;
                hideLoading();
                return;
            }
            
            // Calculate dimensions
            const containerWidth = wordcloudContainer.clientWidth;
            const containerHeight = wordcloudContainer.clientHeight;
            
            // Create SVG
            const svg = d3.select(wordcloudContainer)
                .append('svg')
                .attr('width', containerWidth)
                .attr('height', containerHeight)
                .attr('viewBox', `0 0 ${containerWidth} ${containerHeight}`)
                .style('background-color', backgroundColor);
            
            // Add background rectangle
            svg.append('rect')
                .attr('width', containerWidth)
                .attr('height', containerHeight)
                .attr('fill', backgroundColor);
            
            // Create color scale
            const colorScale = generateColorScale(startColor, endColor, wordFrequencies.length);
            
            // Create word cloud layout
            wordcloudLayout = d3.layout.cloud()
                .size([containerWidth, containerHeight])
                .words(wordFrequencies)
                .padding(2)
                .rotate(() => (Math.random() * 2 - 1) * rotationRange)
                .fontSize(d => Math.sqrt(d.value) * 5 * scaleFactor)
                .on('end', words => {
                    // Draw the word cloud
                    svg.append('g')
                        .attr('transform', `translate(${containerWidth / 2},${containerHeight / 2})`)
                        .selectAll('text')
                        .data(words)
                        .enter()
                        .append('text')
                        .style('font-size', d => `${d.size}px`)
                        .style('font-family', 'Arial, sans-serif')
                        .style('font-weight', 'bold')
                        .style('fill', (d, i) => colorScale(i))
                        .attr('text-anchor', 'middle')
                        .attr('transform', d => `translate(${d.x},${d.y}) rotate(${d.rotate})`)
                        .text(d => d.text);
                        
                    // Enable download buttons
                    downloadPngBtn.disabled = false;
                    downloadSvgBtn.disabled = false;
                    
                    isGenerating = false;
                    hideLoading();
                })
                .spiral(shapeImage ? customSpiral : 'archimedean');
                
            // Apply shape mask if available
            if (shapeImage) {
                // Create a mask canvas based on the shape image
                const maskCanvas = createMaskCanvas(shapeImage, containerWidth, containerHeight);
                const maskContext = maskCanvas.getContext('2d');
                const maskData = maskContext.getImageData(0, 0, containerWidth, containerHeight).data;
                
                // Custom spiral function that considers the mask
                function customSpiral(size, { x, y }) {
                    // Start in the center
                    const start = [containerWidth / 2, containerHeight / 2];
                    const e = 0.1; // Step size
                    let theta = 0;
                    
                    return function() {
                        // Increase the angle
                        theta += e;
                        // Calculate the radius based on the angle
                        const r = (theta + e) * size[0] / (2 * Math.PI);
                        // Calculate new x and y based on polar coordinates
                        const nx = start[0] + r * Math.cos(theta);
                        const ny = start[1] + r * Math.sin(theta);
                        
                        // Check if point is within our mask
                        const i = ((Math.floor(ny) * containerWidth) + Math.floor(nx)) * 4 + 3;
                        
                        // Return the point if it's within the mask, or continue the spiral
                        if (nx >= 0 && nx < containerWidth && 
                            ny >= 0 && ny < containerHeight &&
                            (!maskData || maskData[i] > 128)) {
                            return [nx, ny];
                        }
                        
                        // Continue the spiral
                        return customSpiral(size, { x, y })();
                    };
                }
            }
            
            // Start layout calculation
            wordcloudLayout.start();
        }

        // Function to download as PNG
        function downloadAsPNG() {
            if (!wordcloudContainer.querySelector('svg')) {
                showError('Generate a word cloud first.');
                return;
            }
            
            showLoading('Exporting PNG...');
            
            const scale = parseFloat(exportScaleInput.value);
            const svg = wordcloudContainer.querySelector('svg');
            const width = parseInt(svg.getAttribute('width'));
            const height = parseInt(svg.getAttribute('height'));
            
            // Create a new SVG with the scaled dimensions
            const scaledSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            scaledSvg.setAttribute('width', width * scale);
            scaledSvg.setAttribute('height', height * scale);
            scaledSvg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            scaledSvg.innerHTML = svg.innerHTML;
            
            // Set background color
            const backgroundColor = backgroundColorInput.value;
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', width);
            rect.setAttribute('height', height);
            rect.setAttribute('fill', backgroundColor);
            scaledSvg.insertBefore(rect, scaledSvg.firstChild);
            
            // Convert SVG to a data URL
            const svgData = new XMLSerializer().serializeToString(scaledSvg);
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const svgUrl = URL.createObjectURL(svgBlob);
            
            // Create an image from the SVG
            const img = new Image();
            img.onload = function() {
                // Create a canvas with the scaled dimensions
                const canvas = document.createElement('canvas');
                canvas.width = width * scale;
                canvas.height = height * scale;
                const ctx = canvas.getContext('2d');
                
                // Draw the image on the canvas
                ctx.fillStyle = backgroundColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Create a download link for the PNG
                const pngUrl = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = pngUrl;
                a.download = 'wordcloud.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Clean up
                URL.revokeObjectURL(svgUrl);
                hideLoading();
            };
            img.src = svgUrl;
        }

        // Function to download as SVG
        function downloadAsSVG() {
            if (!wordcloudContainer.querySelector('svg')) {
                showError('Generate a word cloud first.');
                return;
            }
            
            showLoading('Exporting SVG...');
            
            const scale = parseFloat(exportScaleInput.value);
            const svg = wordcloudContainer.querySelector('svg');
            const width = parseInt(svg.getAttribute('width'));
            const height = parseInt(svg.getAttribute('height'));
            
            // Create a new SVG with the scaled dimensions
            const scaledSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            scaledSvg.setAttribute('width', width * scale);
            scaledSvg.setAttribute('height', height * scale);
            scaledSvg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            scaledSvg.innerHTML = svg.innerHTML;
            
            // Set background color
            const backgroundColor = backgroundColorInput.value;
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', width);
            rect.setAttribute('height', height);
            rect.setAttribute('fill', backgroundColor);
            scaledSvg.insertBefore(rect, scaledSvg.firstChild);
            
            // Convert SVG to a data URL
            const svgData = new XMLSerializer().serializeToString(scaledSvg);
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const svgUrl = URL.createObjectURL(svgBlob);
            
            // Create a download link for the SVG
            const a = document.createElement('a');
            a.href = svgUrl;
            a.download = 'wordcloud.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Clean up
            URL.revokeObjectURL(svgUrl);
            hideLoading();
        }

        // Function to show loading message
        function showLoading(message) {
            // Create loading overlay if it doesn't exist
            let loadingOverlay = document.querySelector('.loading');
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading';
                wordcloudContainer.appendChild(loadingOverlay);
            }
            
            loadingOverlay.textContent = message;
            loadingOverlay.style.display = 'flex';
        }

        // Function to hide loading message
        function hideLoading() {
            const loadingOverlay = document.querySelector('.loading');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // Function to show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // Function to hide error message
        function hideError() {
            errorMessage.style.display = 'none';
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
